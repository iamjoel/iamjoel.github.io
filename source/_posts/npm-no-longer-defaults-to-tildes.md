title: npm install --save 不再默认使用波浪符
date: 2014-03-01 10:02:07
tags: [npm,nodejs]
---
原文 http://fredkschott.com/post/2014/02/npm-no-longer-defaults-to-tildes/
<!-- more -->

上周三(2014/02/18/)发布了[新的稳定的node版本](http://blog.nodejs.org/2014/02/18/node-v0-10-26-stable/)，随之而来的是新版本的npm。这次更新修复了很多bugs，但是最易见的变化是,当使用`npm install --save`时，模块版本号的前缀使用了脱字符(`^`)替代了波浪符(`~`)。

这对你来说意味着什么？好吧，首先你要知道这两者之间的区别。简单来说，脱字符匹配最近的最小版本（版本号中间的数字）。比如`~1.2.3`会匹配所有的`1.2.x`版本，但不匹配`1.3.0`。npm[一开始](https://github.com/mikolalysenko/npm/commit/2d970344545d7dfadf217365755afd0cdca5b1f1)执行`--save`的默认行为就是这样的，你可能已经习惯了在[package.json](https://www.npmjs.org/doc/files/package.json.html#dependencies)看到它了。脱字符，另一方面，匹配更加宽泛。它会更新至最近的主要版本（版本号中第一个数字）。`1.2.3`会匹配所有的`1.x.x`的发布版本，包括`1.3.0`，但会止于`2.0.0`。npm的[语义化版本解析](https://github.com/isaacs/node-semver)解释了区别
> ~1.2.3 := >=1.2.3-0 <1.3.0-0 "合理的接近1.2.3" 

> 1.2.3 := >=1.2.3-0 <2.0.0-0 "与1.2.3兼容"
― isaacs/node-semver(重点添加)

"合理的接近"和"兼容"的不同点可追溯到语义化版本（SemVer）。根据版本:
> 给一个版本号 主要.次要.补丁,增加：
* 主要版本 当你使API不兼容旧版本时
* 次要版本 当你添加向后兼容的方法
* 补丁版本 当你修复一些向后兼容的bugs

> \- semver.org

只有主要的版本才能破坏兼容性，开发者可以随意的更改次要和补丁版本，在主版本不变的情况下。脱字符相信规则被遵守，而波浪符保持悲观态度。

当然，所有规则都有意外，语义化版本存在一个预发布版本：
> 主版本0（0.y.z）是处于初始化开发状态。任何事在任意时间都会改变。公共的API不应该被认为是稳定的。

不像1.0或更高版本，0.x的软件只保证一件事： "任何事会在任何时间发生改变"。开发者在早期可以毫无约束的自由并快速的增加版本，这时大部分情况下保持在一个基本版本是明智的。补丁版本通常是修改bugs和内部改变，次要版本是为了其他的情况。

npm的semver解析基于此是明智的，波浪符的行为匹配”付责任的接近“版本是可以保证不改变的。脱字符，不以这种规则工作的。为保持兼容，脱字符只会匹配主版本。但对于0版本的软件，脱字符的行为是和波浪线的行为是一样的。

你可能不会立刻注意的到什么变化，并且你的package.json仍然是这个样子。但当你升级了node，然后你添加了一个新的依赖，你会注意到`package.json`里出现一个脱字符。

最后，你可能考虑将所有的依赖用一个（`^`）替换另一个（`~`）,或替换部分。关于选择哪个在于你的使用情况，使用的依赖和你敢于承担多大的风险。





